<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>NES</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" href="nes.png" type="image/png">
    <style>
       :root {
        color-scheme: light dark;
      }
      @font-face {
  font-family: "Renner";
  src: url("./Renner.ttf") format("truetype");
  font-display: swap;
 
}
      body {
        background:rgb(0, 0, 0);
       font-family: "Renner", sans-serif;
        margin: 0;
        padding:0;
      }
h1{
font-weight:300;
font-size:25px;
}
      header {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 12px;
      }
      canvas{
        
        height: 100%;              /* コンテナ幅に合わせる */
      aspect-ratio: 256 / 240;  /* 内部解像度の比率を維持 */
        image-rendering: pixelated;
        border: 1px solid #000000;
        background: #000;
      }
      .row {
        padding-top:0px;
height:83vh;
justify-content: center; 
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .mono {
       font-size:20px; 
      }
      small {
        opacity: 0.7;
      }
      
button{
font-family: "Renner", sans-serif;
padding:10px;
background:rgb(0, 0, 0);
color:rgb(255, 255, 255);
border:1px solid rgb(255, 255, 255);
}
.file-input {
  display: none; /* 本体は隠す */
}

.file-label {
  display: inline-block;
  padding: 10px 16px;
  background: #000000;
  color: white;
    border:1px solid white;
  border-radius: 0px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s;
}



    </style>
  </head>
  <body>
   
    <header>
<h1>XVM-8</h1>
     
<label class="file-label">
  Select
  <input id="rom" type="file" class="file-input" accept=".bin, .nes">
</label>

<span id="file-name"></span>

      
      <button id="fullscreenBtn">Fullscreen</button>

      <button id="start">Start</button>
      <div class="mono" id="status" style="display:none">No ROM</div>
      <div><span class="mono">CPU PC:</span> <span id="pc" class="mono">0x0000</span></div>
    </header>
 <div class="row">
      <canvas id="screen" width="128" height="128"></canvas>
      
    </div>

    

    <script>
     
class XVM8S {
  constructor() {
    this.mem = new Uint8Array(0x10000);

    // Registers
    this.A = 0;
    this.B = 0;
    this.X = 0;
    this.PC = 0xE000;
    this.F = 0; // bit0 = Zero

    this.halted = false;

    this.canvas = document.getElementById("screen");
    this.ctx = this.canvas.getContext("2d");
    this.imageData = this.ctx.createImageData(128,128);

    this.resetPalette();
  }

  reset() {
    this.A = this.B = this.X = 0;
    this.F = 0;
    this.PC = 0xE000;
    this.halted = false;
  }

  resetPalette() {
    const defaults = [
      0x00,0xFF,0xE0,0x1C,0x03,0xFC,0xE3,0x1F,
      0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
    ];
    for(let i=0;i<16;i++){
      this.mem[0xC000+i] = defaults[i];
    }
  }

  loadROM(buffer) {
    const rom = new Uint8Array(buffer);
    for(let i=0;i<rom.length;i++){
      this.mem[0xE000+i] = rom[i];
    }
  }

  read16() {
  const lo = this.mem[this.PC & 0xFFFF];
  this.PC = (this.PC + 1) & 0xFFFF;

  const hi = this.mem[this.PC & 0xFFFF];
  this.PC = (this.PC + 1) & 0xFFFF;

  return (lo | (hi << 8)) & 0xFFFF;
}


  setZ(v) {
    if((v & 0xFF) === 0) this.F |= 1;
    else this.F &= ~1;
  }

  step() {
   if (this.halted) return;

  if (this.PC < 0 || this.PC > 0xFFFF) {
    console.error("PC out of range:", this.PC);
    this.halted = true;
    return;
  }

  const op = this.mem[this.PC];

  if (op === undefined) {
    console.error("Invalid memory read at", this.PC);
    this.halted = true;
    return;
  }
this.PC++;

    

    switch(op) {
      case 0x00: break; // NOP

      case 0x01: this.A = this.mem[this.PC++]; this.setZ(this.A); break;
      case 0x02: this.B = this.mem[this.PC++]; this.setZ(this.B); break;
      case 0x03: this.X = this.mem[this.PC++]; this.setZ(this.X); break;

      case 0x04: {
        const addr = this.read16();
        this.A = this.mem[addr];
        this.setZ(this.A);
        break;
      }

      case 0x05: {
        const addr = this.read16();
        this.mem[addr] = this.A;
        break;
      }

      case 0x10: this.A = this.B; this.setZ(this.A); break;
      case 0x11: this.B = this.A; this.setZ(this.B); break;
      case 0x12: this.A = this.X; this.setZ(this.A); break;
      case 0x13: this.X = this.A; this.setZ(this.X); break;

      case 0x20:
        this.A = (this.A + this.B) & 0xFF;
        this.setZ(this.A);
        break;

      case 0x25: this.A = (this.A+1)&0xFF; this.setZ(this.A); break;
      case 0x26: this.B = (this.B+1)&0xFF; this.setZ(this.B); break;
      case 0x27: this.X = (this.X+1)&0xFF; this.setZ(this.X); break;

      case 0x30: this.PC = this.read16(); break;

      case 0x31: {
        const addr = this.read16();
        if(this.F & 1) this.PC = addr;
        break;
      }

      case 0x32: {
        const addr = this.read16();
        if(!(this.F & 1)) this.PC = addr;
        break;
      }

      case 0xFF:
        this.halted = true;
        break;

      default:
        console.error("Unknown opcode:", op);
        this.halted = true;
    }
    this.PC &= 0xFFFF;

  }

  rgb332(v){
    const r = ((v >> 5)&7) * 36;
    const g = ((v >> 2)&7) * 36;
    const b = (v & 3) * 85;
    return [r,g,b];
  }

  render() {
    const data = this.imageData.data;

    for(let y=0;y<128;y++){
      for(let x=0;x<128;x++){
        const colIndex = this.mem[0x8000 + y*128 + x] & 0xF;
        const rgb = this.rgb332(this.mem[0xC000+colIndex]);
        const i = (y*128+x)*4;
        data[i] = rgb[0];
        data[i+1] = rgb[1];
        data[i+2] = rgb[2];
        data[i+3] = 255;
      }
    }

    this.ctx.putImageData(this.imageData,0,0);
  }
}

const vm = new XVM8S();

document.getElementById("rom").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  document.getElementById("file-name").textContent = file.name;
  const reader = new FileReader();
  reader.onload = () => {
    vm.loadROM(reader.result);
    vm.reset();
    document.getElementById("status").style.display="block";
    document.getElementById("status").textContent="ROM Loaded";
  };
  reader.readAsArrayBuffer(file);
});

document.getElementById("start").onclick = ()=>{
  function loop(){
    for(let i=0;i<2000;i++) vm.step();
    vm.render();
    document.getElementById("pc").textContent = "0x"+vm.PC.toString(16).padStart(4,"0");
    requestAnimationFrame(loop);
  }
  loop();
};

document.getElementById("fullscreenBtn").onclick = ()=>{
  document.body.requestFullscreen();
};


    </script>


  </body>
</html>